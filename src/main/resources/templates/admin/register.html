<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Admin - Register Card</title>
    <link rel="stylesheet" href="/css/card-list.css" />
    <style>
      .admin-container {
        max-width: 600px;
        margin: 50px auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
      }
      .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
      }
      .price-input-wrapper {
        position: relative;
      }
      .price-input-wrapper::before {
        content: "₩";
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-weight: bold;
        z-index: 1;
      }
      .price-input-wrapper input {
        padding-left: 30px;
      }
      .usd-input-wrapper {
        position: relative;
      }
      .usd-input-wrapper::before {
        content: "$";
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-weight: bold;
        z-index: 1;
      }
      .usd-input-wrapper input {
        padding-left: 30px;
      }
      .help-text {
        font-size: 0.85em;
        color: #888;
        margin-top: 5px;
      }
      .btn-submit {
        width: 100%;
        padding: 12px;
        background: #4338ca;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1em;
        cursor: pointer;
      }
      .btn-submit:hover {
        background: #3730a3;
      }
      .alert {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .alert-success {
        background: #dcfce7;
        color: #166534;
      }
      .alert-error {
        background: #fee2e2;
        color: #991b1b;
      }
      /* 로딩 오버레이 */
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 9999;
        justify-content: center;
        align-items: center;
      }
      .loading-overlay.active {
        display: flex;
      }
      .loading-content {
        background: white;
        padding: 40px;
        border-radius: 10px;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }
      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4338ca;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .loading-text {
        font-size: 1.1em;
        color: #333;
        margin-bottom: 15px;
        font-weight: bold;
      }
      .loading-progress {
        width: 100%;
        height: 8px;
        background-color: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 15px;
      }
      .loading-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #4338ca, #6366f1);
        width: 0%;
        animation: progress 2s ease-in-out infinite;
        border-radius: 4px;
      }
      @keyframes progress {
        0% {
          width: 0%;
        }
        50% {
          width: 70%;
        }
        100% {
          width: 100%;
        }
      }
      .loading-steps {
        margin-top: 15px;
        font-size: 0.9em;
        color: #666;
      }
      .loading-step {
        margin: 5px 0;
        opacity: 0.6;
      }
      .loading-step.active {
        opacity: 1;
        color: #4338ca;
        font-weight: bold;
      }
      .admin-tab-btn {
        padding: 12px 24px;
        background: #e5e7eb;
        color: #666;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
      }
      .admin-tab-btn:hover {
        background: #d1d5db;
      }
      .admin-tab-btn.active {
        background: #4338ca;
        color: white;
      }
      #listSection {
        display: none;
      }
    </style>
  </head>
  <body>
    <div style="text-align: center; margin-bottom: 20px">
      <a href="/cards" class="back-btn">← Go to Market</a>
    </div>

    <div class="admin-container">
      <div
        style="
          display: flex;
          gap: 10px;
          justify-content: center;
          margin-bottom: 30px;
        "
      >
        <button
          id="registerBtn"
          class="admin-tab-btn active"
          onclick="showRegisterForm()"
        >
          카드 등록
        </button>
        <button id="listBtn" class="admin-tab-btn" onclick="showCardList()">
          카드 목록 보기
        </button>
      </div>

      <div id="registerSection">
        <h2 style="margin-top: 0; text-align: center">카드 등록</h2>
        <p style="text-align: center; color: #666; margin-bottom: 30px">
          카드의 정보를 입력하면 <br />DB에 자동으로 저장합니다
        </p>

        <div
          th:if="${message}"
          class="alert alert-success"
          th:text="${message}"
        ></div>
        <div
          th:if="${error}"
          class="alert alert-error"
          th:text="${error}"
        ></div>

        <form
          action="/admin/cards/register"
          method="post"
          enctype="multipart/form-data"
        >
          <input
            type="hidden"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}"
          />
          <div class="form-group">
            <label for="name">포켓몬 이름 (Name)</label>
            <input
              type="text"
              id="name"
              name="name"
              placeholder="예: Pikachu"
            />
            <div class="help-text">* 영문 이름 권장 (한글 검색 불가)</div>
          </div>

          <div class="form-group">
            <label for="number">카드 번호 (Number)</label>
            <input
              type="text"
              id="number"
              name="number"
              placeholder="예: 025"
            />
            <div class="help-text">
              * 카드 하단의 숫자 (예: 025/165 라면 025 입력)
            </div>
          </div>

          <div class="form-group">
            <label for="setName">세트 이름 (Set Name) - 선택사항</label>
            <input
              type="text"
              id="setName"
              name="setName"
              placeholder="예: 151, 초전 브레이"
            />
            <div class="help-text">
              * 카드가 속한 세트 이름을 입력하세요.
            </div>
          </div>

          <div class="form-group">
            <label for="rarity">희귀도 (Rarity) - 선택사항</label>
            <select
              id="rarity"
              name="rarity"
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;"
            >
              <option value="">선택 안 함</option>
              <option th:each="rarity : ${rarities}" 
                      th:value="${rarity.name()}" 
                      th:text="${rarity.name()}">
                COMMON
              </option>
            </select>
            <div class="help-text">
              * 카드의 희귀도를 선택하세요. (COMMON, UNCOMMON, RARE, HOLO_RARE, DOUBLE_RARE, ULTRA_RARE, ILLUSTRATION_RARE, SECRET_RARE, PROMO, UNKNOWN)
            </div>
          </div>

          <div class="form-group">
            <label for="cardCondition">카드 상태 (Condition) - 선택사항</label>
            <select
              id="cardCondition"
              name="cardCondition"
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;"
            >
              <option value="">선택 안 함</option>
              <option th:each="condition : ${cardConditions}" 
                      th:value="${condition.name()}" 
                      th:text="${condition.name() + ' - ' + condition.description}">
                MINT - 미개봄/신품
              </option>
            </select>
            <div class="help-text">
              * 카드의 상태를 선택하세요. (MINT: 미개봄/신품, NEAR_MINT: S급, EXCELLENT: A급, LIGHTLY_PLAYED: B급, PLAYED: C급, HEAVILY_PLAYED: D급, DAMAGED: 파손됨)
            </div>
          </div>

          <div class="form-group">
            <label for="collectionStatus">컬렉션 상태 (Collection Status) - 선택사항</label>
            <select
              id="collectionStatus"
              name="collectionStatus"
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;"
            >
              <option value="">선택 안 함</option>
              <option th:each="status : ${collectionStatuses}" 
                      th:value="${status.name()}" 
                      th:text="${status.name() + ' - ' + status.description}">
                OWNED - 보유중
              </option>
            </select>
            <div class="help-text">
              * 카드의 컬렉션 상태를 선택하세요. (OWNED: 보유중, WHISHLIST: 위시리스트, FOR_TRADE: 교환중, FOR_SALE: 판매중, TRADED: 교환 완료, SOLD: 판매 완료)
            </div>
          </div>

          <div class="form-group">
            <label for="imageFile">카드 이미지 업로드 - 선택사항</label>
            <input
              type="file"
              id="imageFile"
              name="imageFile"
              accept="image/*"
              style="padding: 8px"
            />
            <div class="help-text">
              * 로컬 컴퓨터에서 카드 이미지를 업로드할 수 있습니다. (jpg, png,
              gif, webp)
            </div>
            <div id="imagePreview" style="margin-top: 10px; display: none">
              <img
                id="previewImg"
                src=""
                alt="미리보기"
                style="
                  max-width: 300px;
                  max-height: 300px;
                  border: 1px solid #ddd;
                  border-radius: 5px;
                "
              />
            </div>
          </div>

          <div class="form-group">
            <label for="salePrice">판매 가격 (원화) - 선택사항</label>
            <div class="price-input-wrapper">
              <input
                type="text"
                id="salePrice"
                name="salePrice"
                placeholder="예: 50000"
                inputmode="numeric"
                pattern="[0-9]*"
              />
            </div>
            <div class="help-text">
              * 판매하고자 하는 가격을 원화(₩)로 입력하세요. 숫자만 입력
              가능합니다.
            </div>
          </div>

          <div class="form-group">
            <label for="currentPriceUsd">현재 시세 (USD) - 선택사항</label>
            <div class="usd-input-wrapper">
              <input
                type="text"
                id="currentPriceUsd"
                name="currentPriceUsd"
                placeholder="25.99"
                inputmode="decimal"
                pattern="[0-9]+(\.[0-9]+)?"
              />
            </div>
            <div class="help-text">
              * 카드의 현재 시세를 USD로 입력하세요. 소수점 포함 가능합니다. (예: 25.99)
              <br>* 입력된 시세는 그래프 데이터로 축적되어 가격 추이를 확인할 수 있습니다.
            </div>
          </div>

          <button type="submit" class="btn-submit" id="submitBtn">
            카드 검색 및 등록
          </button>
        </form>
      </div>

      <!-- 카드 목록 섹션 (같은 페이지에서 표시) -->
      <div id="listSection">
        <h2 style="margin-top: 0; text-align: center">등록된 카드 목록</h2>
        <p style="text-align: center; color: #666; margin-bottom: 30px">
          지금까지 등록된 모든 카드를 확인할 수 있습니다.
        </p>
        <div style="text-align: center; margin-bottom: 20px">
          <a
            href="/admin/cards/list"
            class="admin-tab-btn"
            style="text-decoration: none; display: inline-block"
          >
            전체 목록 보기 →
          </a>
        </div>
      </div>

      <!-- 로딩 오버레이 -->
      <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <div class="loading-text">카드 등록 중...</div>
          <div class="loading-progress">
            <div class="loading-progress-bar"></div>
          </div>
          <div class="loading-steps">
            <div class="loading-step active" id="step1">
              ✓ 이미지 업로드 중...
            </div>
            <div class="loading-step" id="step2">
              API에서 카드 정보 검색 중...
            </div>
            <div class="loading-step" id="step3">데이터베이스에 저장 중...</div>
          </div>
        </div>
      </div>

      <script>
        // 이미지 미리보기 기능
        document
          .getElementById("imageFile")
          .addEventListener("change", function (e) {
            const file = e.target.files[0];
            const previewDiv = document.getElementById("imagePreview");
            const previewImg = document.getElementById("previewImg");

            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                previewImg.src = e.target.result;
                previewDiv.style.display = "block";
              };
              reader.readAsDataURL(file);
            } else {
              previewDiv.style.display = "none";
            }
          });

        // 판매 가격 입력란: 숫자만 입력 가능하도록 제한
        document
          .getElementById("salePrice")
          .addEventListener("input", function (e) {
            // 숫자가 아닌 문자 제거
            this.value = this.value.replace(/[^0-9]/g, "");
          });

        // 숫자 키만 허용 (백스페이스, 삭제, 탭, 화살표 등은 허용)
        document
          .getElementById("salePrice")
          .addEventListener("keydown", function (e) {
            // 숫자 키 (0-9), 백스페이스, 삭제, 탭, 화살표 키는 허용
            if (
              !(
                (e.key >= "0" && e.key <= "9") ||
                e.key === "Backspace" ||
                e.key === "Delete" ||
                e.key === "Tab" ||
                e.key === "ArrowLeft" ||
                e.key === "ArrowRight" ||
                e.key === "ArrowUp" ||
                e.key === "ArrowDown"
              )
            ) {
              e.preventDefault();
            }
          });

        // 현재 시세(USD) 입력란: 숫자와 소수점만 입력 가능하도록 제한
        document
          .getElementById("currentPriceUsd")
          .addEventListener("input", function (e) {
            // 숫자와 소수점만 허용 (소수점은 하나만)
            let value = this.value;
            // 숫자, 소수점, 백스페이스, 삭제 외의 문자 제거
            value = value.replace(/[^0-9.]/g, "");
            // 소수점이 여러 개인 경우 첫 번째만 유지
            const parts = value.split(".");
            if (parts.length > 2) {
              value = parts[0] + "." + parts.slice(1).join("");
            }
            // 소수점 두 자리까지만 허용
            if (parts.length === 2 && parts[1].length > 2) {
              value = parts[0] + "." + parts[1].substring(0, 2);
            }
            this.value = value;
          });

        // 현재 시세(USD) 입력란: 키보드 입력 제한
        document
          .getElementById("currentPriceUsd")
          .addEventListener("keydown", function (e) {
            // 숫자 키 (0-9), 소수점(.), 백스페이스, 삭제, 탭, 화살표 키만 허용
            if (
              !(
                (e.key >= "0" && e.key <= "9") ||
                e.key === "." ||
                e.key === "Backspace" ||
                e.key === "Delete" ||
                e.key === "Tab" ||
                e.key === "ArrowLeft" ||
                e.key === "ArrowRight" ||
                e.key === "ArrowUp" ||
                e.key === "ArrowDown"
              )
            ) {
              e.preventDefault();
            }
            // 소수점이 이미 있으면 또 입력하지 못하게
            if (e.key === "." && this.value.includes(".")) {
              e.preventDefault();
            }
          });

        // 폼 제출 시 로딩 오버레이 표시
        document.querySelector("form").addEventListener("submit", function (e) {
          const loadingOverlay = document.getElementById("loadingOverlay");
          const submitBtn = document.getElementById("submitBtn");
          const imageFile = document.getElementById("imageFile");

          // 폼 유효성 검사
          const name = document.getElementById("name").value.trim();
          const number = document.getElementById("number").value.trim();
          const setId = document.getElementById("setId").value.trim();

          if (!name && !number && !setId && !imageFile.files.length) {
            e.preventDefault();
            alert("최소한 하나의 정보는 입력해야 합니다.");
            return;
          }

          // 로딩 오버레이 표시
          loadingOverlay.classList.add("active");
          submitBtn.disabled = true;
          submitBtn.textContent = "처리 중...";

          // 단계별 애니메이션
          setTimeout(function () {
            document.getElementById("step1").classList.add("active");
            document.getElementById("step1").textContent =
              "✓ 이미지 업로드 완료";
          }, 500);

          setTimeout(function () {
            document.getElementById("step2").classList.add("active");
            document.getElementById("step2").textContent =
              "✓ API에서 카드 정보 검색 중...";
          }, 1500);

          setTimeout(function () {
            document.getElementById("step3").classList.add("active");
            document.getElementById("step3").textContent =
              "✓ 데이터베이스에 저장 중...";
          }, 3000);
        });

        // 탭 전환 기능
        function showRegisterForm() {
          document.getElementById("registerSection").style.display = "block";
          document.getElementById("listSection").style.display = "none";
          document.getElementById("registerBtn").classList.add("active");
          document.getElementById("listBtn").classList.remove("active");
        }

        function showCardList() {
          // 같은 페이지에서 섹션 전환
          document.getElementById("registerSection").style.display = "none";
          document.getElementById("listSection").style.display = "block";
          document.getElementById("registerBtn").classList.remove("active");
          document.getElementById("listBtn").classList.add("active");

          const listSection = document.getElementById("listSection");
          // 기존 내용을 초기화하고 로딩 메시지 표시
          listSection.innerHTML = `
            <h2 style="margin-top: 0; text-align: center">등록된 카드 목록</h2>
            <p style="text-align: center; color: #666; margin-bottom: 30px">
              지금까지 등록된 모든 카드를 확인할 수 있습니다.
            </p>
            <div style="text-align: center; margin-bottom: 20px">
              <a
                href="/admin/cards/list"
                class="admin-tab-btn"
                style="text-decoration: none; display: inline-block"
              >
                전체 목록 보기 →
              </a>
            </div>
            <p style="text-align: center; color: #666;">카드 목록을 불러오는 중...</p>
          `;

          // 카드 목록을 동적으로 로드 (AJAX)
          fetch("/admin/cards/list-data")
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              if (data.length === 0) {
                listSection.innerHTML = `
                  <h2 style="margin-top: 0; text-align: center">등록된 카드 목록</h2>
                  <p style="text-align: center; color: #666; margin-bottom: 30px">
                    지금까지 등록된 모든 카드를 확인할 수 있습니다.
                  </p>
                  <div style="text-align: center; margin-bottom: 20px">
                    <a
                      href="/admin/cards/list"
                      class="admin-tab-btn"
                      style="text-decoration: none; display: inline-block"
                    >
                      전체 목록 보기 →
                    </a>
                  </div>
                  <p style="text-align: center; color: #999;">등록된 카드가 없습니다.</p>
                `;
              } else {
                let html = `
                  <h2 style="margin-top: 0; text-align: center">등록된 카드 목록</h2>
                  <p style="text-align: center; color: #666; margin-bottom: 30px">
                    지금까지 등록된 모든 카드를 확인할 수 있습니다.
                  </p>
                  <div style="text-align: center; margin-bottom: 20px">
                    <a
                      href="/admin/cards/list"
                      class="admin-tab-btn"
                      style="text-decoration: none; display: inline-block"
                    >
                      전체 목록 보기 →
                    </a>
                  </div>
                  <div class="card-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; margin-top: 20px;">
                `;
                data.forEach((card) => {
                  const imageUrl = card.imageUrl || '/images/pokemon-card.png';
                  const rarity = card.rarity || 'N/A';
                  html += `
                    <div class="card-item" onclick="location.href='/cards/${card.id}'" style="cursor: pointer; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                      <div class="card-image">
                        <img src="${imageUrl}" alt="${card.name || 'Card'}" style="width: 100%; height: 300px; object-fit: contain;" 
                             onerror="this.src='/images/pokemon-card.png'; this.onerror=null;" />
                      </div>
                      <div class="card-info" style="padding: 15px;">
                        <h3 style="margin: 0 0 5px 0;">${card.name || 'Unknown'}</h3>
                        <p style="margin: 0 0 10px 0; color: #666; font-size: 0.9em;">${card.setName || 'Unknown Set'}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                          <span style="color: #666; font-size: 0.85em;">${rarity}</span>
                          <span style="font-weight: bold; color: #4338ca;">${card.priceDisplay || '가격 정보 없음'}</span>
                        </div>
                      </div>
                    </div>
                  `;
                });
                html += "</div>";
                listSection.innerHTML = html;
              }
            })
            .catch((error) => {
              console.error("카드 목록 로드 실패:", error);
              listSection.innerHTML = `
                <h2 style="margin-top: 0; text-align: center">등록된 카드 목록</h2>
                <p style="text-align: center; color: #666; margin-bottom: 30px">
                  지금까지 등록된 모든 카드를 확인할 수 있습니다.
                </p>
                <div style="text-align: center; margin-bottom: 20px">
                  <a
                    href="/admin/cards/list"
                    class="admin-tab-btn"
                    style="text-decoration: none; display: inline-block"
                  >
                    전체 목록 보기 →
                  </a>
                </div>
                <p style="text-align: center; color: #991b1b;">카드 목록을 불러오는 중 오류가 발생했습니다. (${error.message})</p>
              `;
            });
        }
      </script>
    </div>
  </body>
</html>
