<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Edit Card</title>
    <link rel="stylesheet" href="/css/card-list.css" />
    <style>
      * {
        box-sizing: border-box;
      }
      .admin-container {
        max-width: 600px;
        margin: 50px auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      
      /* ëª¨ë°”ì¼ ëŒ€ì‘ */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }
        .admin-container {
          margin: 20px auto;
          padding: 20px;
          width: 100%;
          max-width: 100%;
        }
        .current-image {
          max-width: 100%;
        }
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
      }
      .price-input-wrapper {
        position: relative;
      }
      .price-input-wrapper::before {
        content: 'â‚©';
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-weight: bold;
        z-index: 1;
      }
      .price-input-wrapper input {
        padding-left: 30px;
      }
      .usd-input-wrapper {
        position: relative;
      }
      .usd-input-wrapper::before {
        content: "$";
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-weight: bold;
        z-index: 1;
      }
      .usd-input-wrapper input {
        padding-left: 30px;
      }
      .help-text {
        font-size: 0.85em;
        color: #888;
        margin-top: 5px;
      }
      .btn-submit {
        width: 100%;
        padding: 12px;
        background: #4338ca;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1em;
        cursor: pointer;
        margin-top: 10px;
      }
      .btn-submit:hover {
        background: #3730a3;
      }
      .btn-cancel {
        width: 100%;
        padding: 12px;
        background: #6b7280;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1em;
        cursor: pointer;
        margin-top: 10px;
        text-decoration: none;
        display: block;
        text-align: center;
      }
      .btn-cancel:hover {
        background: #4b5563;
      }
      .alert {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .alert-success {
        background: #dcfce7;
        color: #166534;
      }
      .alert-error {
        background: #fee2e2;
        color: #991b1b;
      }
      .current-image {
        margin-top: 10px;
        max-width: 300px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div style="text-align: center; margin-bottom: 20px">
      <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
        <a href="/admin/cards/list" class="back-btn">â† ì¹´ë“œ ëª©ë¡</a>
        <a href="/admin/notices" class="back-btn" style="background-color: #6b7280;">ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬</a>
      </div>
    </div>

    <div class="admin-container">
      <h2 style="margin-top: 0; text-align: center">ì¹´ë“œ ì •ë³´ ìˆ˜ì •</h2>

      <div
        th:if="${message}"
        class="alert alert-success"
        th:text="${message}"
      ></div>
      <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

      <form th:action="@{/admin/cards/edit/{id}(id=${card.id})}" method="post" enctype="multipart/form-data">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        
        <div class="form-group">
          <label for="name">í¬ì¼“ëª¬ ì´ë¦„ (Name)</label>
          <input type="text" id="name" name="name" th:value="${card.name}" required />
        </div>

        <div class="form-group">
          <label for="setName">ì„¸íŠ¸ ì´ë¦„ (Set Name)</label>
          <input type="text" id="setName" name="setName" th:value="${card.setName}" required />
        </div>

        <div class="form-group">
          <label for="number">ì¹´ë“œ ë²ˆí˜¸ (Number)</label>
          <input type="text" id="number" name="number" th:value="${card.number}" />
          <div class="help-text">ì˜ˆ: 025/165</div>
        </div>

        <div class="form-group">
          <label for="rarity">í¬ê·€ë„ (Rarity)</label>
          <select id="rarity" name="rarity">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option th:each="r : ${rarities}" 
                    th:value="${r.name()}" 
                    th:text="${r.name()}"
                    th:selected="${card.rarity == r}">
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="cardCondition">ì¹´ë“œ ìƒíƒœ (Condition)</label>
          <select id="cardCondition" name="cardCondition">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option th:each="condition : ${cardConditions}" 
                    th:value="${condition.name()}" 
                    th:text="${condition.name() + ' - ' + condition.description}"
                    th:selected="${card.cardCondition == condition}">
            </option>
          </select>
          <div class="help-text">MINT: ë¯¸ê°œë´‰/ì‹ í’ˆ, NEAR_MINT: Sê¸‰ (ê±°ì˜ ìƒˆê²ƒ), EXCELLENT: Aê¸‰ (ì•½ê°„ì˜ ì‚¬ìš©ê°), LIGHTLY_PLAYED: Bê¸‰ (ëˆˆì— ë„ëŠ” ìƒì²˜), PLAYED: Cê¸‰ (í”Œë ˆì´ìš©), HEAVILY_PLAYED: Dê¸‰ (ì‹¬í•œ ì‚¬ìš© í”ì ), DAMAGED: íŒŒì†ë¨</div>
        </div>

        <div class="form-group">
          <label for="collectionStatus">ì»¬ë ‰ì…˜ ìƒíƒœ (Collection Status)</label>
          <select id="collectionStatus" name="collectionStatus">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option th:each="status : ${collectionStatuses}" 
                    th:value="${status.name()}" 
                    th:text="${status.name() + ' - ' + status.description}"
                    th:selected="${card.collectionStatus == status}">
            </option>
          </select>
          <div class="help-text">OWNED: ë³´ìœ ì¤‘, WHISHLIST: ìœ„ì‹œë¦¬ìŠ¤íŠ¸(ê°–ê³ ì‹¶ìŒ), FOR_TRADE: êµí™˜ì¤‘, FOR_SALE: íŒë§¤ì¤‘, TRADED: êµí™˜ ì™„ë£Œ, SOLD: íŒë§¤ ì™„ë£Œ</div>
        </div>

        <div class="form-group">
          <label for="quantity">ìˆ˜ëŸ‰ (Quantity)</label>
          <input
            type="text"
            id="quantity"
            name="quantity"
            th:value="${card.quantity != null ? card.quantity : 1}"
            placeholder="ì˜ˆ: 1"
            inputmode="numeric"
            pattern="[0-9]*"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;"
          />
          <div class="help-text">
            * ë³´ìœ  ì¤‘ì¸ ì¹´ë“œì˜ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”. ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ê¸°ë³¸ê°’: 1)
          </div>
        </div>

        <div class="form-group">
          <label for="imageUrl">ì´ë¯¸ì§€ URL</label>
          <input type="text" id="imageUrl" name="imageUrl" th:value="${card.imageUrl}" />
          <div class="help-text">ì™¸ë¶€ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ì—ì„œ ìƒˆ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.</div>
          <div th:if="${card.uploadedImageUrl != null}" style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 5px;">
            <p style="font-size: 0.85em; color: #666; margin-bottom: 5px;"><strong>ì—…ë¡œë“œëœ ì´ë¯¸ì§€ URL:</strong></p>
            <p style="font-size: 0.8em; color: #4338ca; word-break: break-all;" th:text="${card.uploadedImageUrl}"></p>
          </div>
          <div th:if="${card.getDisplayImageUrl() != null}" style="margin-top: 10px;">
            <p style="font-size: 0.9em; color: #666; margin-bottom: 5px;"><strong>í˜„ì¬ í‘œì‹œë˜ëŠ” ì´ë¯¸ì§€:</strong></p>
            <img th:src="${card.getDisplayImageUrl()}" alt="í˜„ì¬ ì´ë¯¸ì§€" class="current-image" 
                 onerror="this.onerror=null; this.src='/images/pokemon-card.png';" />
            <p style="font-size: 0.8em; color: #666; margin-top: 5px; word-break: break-all;" th:text="${card.getDisplayImageUrl()}"></p>
          </div>
        </div>

        <div class="form-group">
          <label for="imageFile">ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
          <input
            type="file"
            id="imageFile"
            name="imageFile"
            accept="image/*"
            style="padding: 8px;"
          />
          <div class="help-text">ìƒˆ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ ê¸°ì¡´ ì´ë¯¸ì§€ë¥¼ ëŒ€ì²´í•©ë‹ˆë‹¤.</div>
          <div id="imagePreview" style="margin-top: 10px; display: none;">
            <img id="previewImg" src="" alt="ë¯¸ë¦¬ë³´ê¸°" style="max-width: 300px; max-height: 300px; border: 1px solid #ddd; border-radius: 5px;" />
          </div>
        </div>

        <div class="form-group">
          <label for="quantity">ìˆ˜ëŸ‰ (Quantity)</label>
          <input
            type="text"
            id="quantity"
            name="quantity"
            th:value="${card.quantity != null ? card.quantity : 1}"
            placeholder="ì˜ˆ: 1"
            inputmode="numeric"
            pattern="[0-9]*"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;"
          />
          <div class="help-text">
            * ë³´ìœ  ì¤‘ì¸ ì¹´ë“œì˜ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”. ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ê¸°ë³¸ê°’: 1)
          </div>
        </div>

        <div class="form-group">
          <label for="salePrice">íŒë§¤ ê°€ê²© (ì›í™”)</label>
          <div class="price-input-wrapper">
            <input
              type="text"
              id="salePrice"
              name="salePrice"
              th:value="${card.salePrice}"
              placeholder="ì˜ˆ: 50000"
              inputmode="numeric"
              pattern="[0-9]*"
            />
          </div>
          <div class="help-text">íŒë§¤í•˜ê³ ì í•˜ëŠ” ê°€ê²©ì„ ì›í™”(â‚©)ë¡œ ì…ë ¥í•˜ì„¸ìš”.</div>
        </div>

        <div class="form-group">
          <label for="currentPriceUsd">í˜„ì¬ ì‹œì„¸ (USD) - ì„ íƒì‚¬í•­</label>
          <div class="usd-input-wrapper">
            <input
              type="text"
              id="currentPriceUsd"
              name="currentPriceUsd"
              th:value="${currentMarketPrice != null && currentMarketPrice.price != null ? currentMarketPrice.price : ''}"
              placeholder="25.99"
              inputmode="decimal"
              pattern="[0-9]+(\.[0-9]+)?"
            />
          </div>
          <div class="help-text">
            * ì¹´ë“œì˜ í˜„ì¬ ì‹œì„¸ë¥¼ USDë¡œ ì…ë ¥í•˜ì„¸ìš”. ì†Œìˆ˜ì  í¬í•¨ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ì˜ˆ: 25.99)
            <br>* ì…ë ¥ëœ ì‹œì„¸ëŠ” ê·¸ë˜í”„ ë°ì´í„°ë¡œ ì¶•ì ë˜ì–´ ê°€ê²© ì¶”ì´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            <br>* ê¸°ì¡´ ì‹œì„¸ë¥¼ ë³€ê²½í•˜ë©´ ìƒˆë¡œìš´ ì‹œì„¸ë¡œ ì—…ë°ì´íŠ¸ë˜ê³ , PriceHistoryì— ê¸°ë¡ì´ ì¶”ê°€ë©ë‹ˆë‹¤.
          </div>
        </div>

        <button type="submit" class="btn-submit">ìˆ˜ì • ì™„ë£Œ</button>
        <a href="/admin/cards/list" class="btn-cancel">ì·¨ì†Œ</a>
      </form>
    </div>

    <script>
      // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
      document.getElementById('imageFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const previewDiv = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            previewImg.src = e.target.result;
            previewDiv.style.display = 'block';
          };
          reader.readAsDataURL(file);
        } else {
          previewDiv.style.display = 'none';
        }
      });

      // ìˆ˜ëŸ‰ ì…ë ¥ë€: ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•˜ë„ë¡ ì œí•œ
      document.getElementById('quantity').addEventListener('input', function(e) {
        // ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ì ì œê±°
        this.value = this.value.replace(/[^0-9]/g, '');
      });

      // ìˆ˜ëŸ‰ ì…ë ¥ë€: í‚¤ë³´ë“œ ì…ë ¥ ì œí•œ
      document.getElementById('quantity').addEventListener('keydown', function(e) {
        // ìˆ«ì í‚¤ (0-9), ë°±ìŠ¤í˜ì´ìŠ¤, ì‚­ì œ, íƒ­, í™”ì‚´í‘œ í‚¤ë§Œ í—ˆìš©
        if (
          !(
            (e.key >= '0' && e.key <= '9') ||
            e.key === 'Backspace' ||
            e.key === 'Delete' ||
            e.key === 'Tab' ||
            e.key === 'ArrowLeft' ||
            e.key === 'ArrowRight' ||
            e.key === 'ArrowUp' ||
            e.key === 'ArrowDown'
          )
        ) {
          e.preventDefault();
        }
      });

      // íŒë§¤ ê°€ê²© ì…ë ¥ë€: ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•˜ë„ë¡ ì œí•œ
      document.getElementById('salePrice').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
      });

      // í˜„ì¬ ì‹œì„¸(USD) ì…ë ¥ë€: ìˆ«ìì™€ ì†Œìˆ˜ì ë§Œ ì…ë ¥ ê°€ëŠ¥í•˜ë„ë¡ ì œí•œ
      const currentPriceUsdInput = document.getElementById('currentPriceUsd');
      if (currentPriceUsdInput) {
        currentPriceUsdInput.addEventListener('input', function(e) {
          // ìˆ«ìì™€ ì†Œìˆ˜ì ë§Œ í—ˆìš© (ì†Œìˆ˜ì ì€ í•˜ë‚˜ë§Œ)
          let value = this.value;
          // ìˆ«ì, ì†Œìˆ˜ì , ë°±ìŠ¤í˜ì´ìŠ¤, ì‚­ì œ ì™¸ì˜ ë¬¸ì ì œê±°
          value = value.replace(/[^0-9.]/g, '');
          // ì†Œìˆ˜ì ì´ ì—¬ëŸ¬ ê°œì¸ ê²½ìš° ì²« ë²ˆì§¸ë§Œ ìœ ì§€
          const parts = value.split('.');
          if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
          }
          // ì†Œìˆ˜ì  ë‘ ìë¦¬ê¹Œì§€ë§Œ í—ˆìš©
          if (parts.length === 2 && parts[1].length > 2) {
            value = parts[0] + '.' + parts[1].substring(0, 2);
          }
          this.value = value;
        });

        // í˜„ì¬ ì‹œì„¸(USD) ì…ë ¥ë€: í‚¤ë³´ë“œ ì…ë ¥ ì œí•œ
        currentPriceUsdInput.addEventListener('keydown', function(e) {
          // ìˆ«ì í‚¤ (0-9), ì†Œìˆ˜ì (.), ë°±ìŠ¤í˜ì´ìŠ¤, ì‚­ì œ, íƒ­, í™”ì‚´í‘œ í‚¤ë§Œ í—ˆìš©
          if (
            !(
              (e.key >= '0' && e.key <= '9') ||
              e.key === '.' ||
              e.key === 'Backspace' ||
              e.key === 'Delete' ||
              e.key === 'Tab' ||
              e.key === 'ArrowLeft' ||
              e.key === 'ArrowRight' ||
              e.key === 'ArrowUp' ||
              e.key === 'ArrowDown'
            )
          ) {
            e.preventDefault();
          }
          // ì†Œìˆ˜ì ì´ ì´ë¯¸ ìˆìœ¼ë©´ ë˜ ì…ë ¥í•˜ì§€ ëª»í•˜ê²Œ
          if (e.key === '.' && this.value.includes('.')) {
            e.preventDefault();
          }
        });
      }
    </script>
  </body>
</html>

