<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Edit Card</title>
    <link rel="stylesheet" href="/css/card-list.css" />
    <style>
      * {
        box-sizing: border-box;
      }
      .admin-container {
        max-width: 600px;
        margin: 50px auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      
      /* 모바일 대응 */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }
        .admin-container {
          margin: 20px auto;
          padding: 20px;
          width: 100%;
          max-width: 100%;
        }
        .current-image {
          max-width: 100%;
        }
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
      }
      .price-input-wrapper {
        position: relative;
      }
      .price-input-wrapper::before {
        content: '₩';
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-weight: bold;
        z-index: 1;
      }
      .price-input-wrapper input {
        padding-left: 30px;
      }
      .usd-input-wrapper {
        position: relative;
      }
      .usd-input-wrapper::before {
        content: "$";
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-weight: bold;
        z-index: 1;
      }
      .usd-input-wrapper input {
        padding-left: 30px;
      }
      .help-text {
        font-size: 0.85em;
        color: #888;
        margin-top: 5px;
      }
      .btn-submit {
        width: 100%;
        padding: 12px;
        background: #4338ca;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1em;
        cursor: pointer;
        margin-top: 10px;
      }
      .btn-submit:hover {
        background: #3730a3;
      }
      .btn-cancel {
        width: 100%;
        padding: 12px;
        background: #6b7280;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1em;
        cursor: pointer;
        margin-top: 10px;
        text-decoration: none;
        display: block;
        text-align: center;
      }
      .btn-cancel:hover {
        background: #4b5563;
      }
      .alert {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .alert-success {
        background: #dcfce7;
        color: #166534;
      }
      .alert-error {
        background: #fee2e2;
        color: #991b1b;
      }
      .current-image {
        margin-top: 10px;
        max-width: 300px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div style="text-align: center; margin-bottom: 20px">
      <a href="/admin/cards/list" class="back-btn">← 카드 목록으로 돌아가기</a>
    </div>

    <div class="admin-container">
      <h2 style="margin-top: 0; text-align: center">카드 정보 수정</h2>

      <div
        th:if="${message}"
        class="alert alert-success"
        th:text="${message}"
      ></div>
      <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

      <form th:action="@{/admin/cards/edit/{id}(id=${card.id})}" method="post" enctype="multipart/form-data">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        
        <div class="form-group">
          <label for="name">포켓몬 이름 (Name)</label>
          <input type="text" id="name" name="name" th:value="${card.name}" required />
        </div>

        <div class="form-group">
          <label for="setName">세트 이름 (Set Name)</label>
          <input type="text" id="setName" name="setName" th:value="${card.setName}" required />
        </div>

        <div class="form-group">
          <label for="number">카드 번호 (Number)</label>
          <input type="text" id="number" name="number" th:value="${card.number}" />
          <div class="help-text">예: 025/165</div>
        </div>

        <div class="form-group">
          <label for="rarity">희귀도 (Rarity)</label>
          <select id="rarity" name="rarity">
            <option value="">선택하세요</option>
            <option th:each="r : ${rarities}" 
                    th:value="${r.name()}" 
                    th:text="${r.name()}"
                    th:selected="${card.rarity == r}">
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="cardCondition">카드 상태 (Condition)</label>
          <select id="cardCondition" name="cardCondition">
            <option value="">선택하세요</option>
            <option th:each="condition : ${cardConditions}" 
                    th:value="${condition.name()}" 
                    th:text="${condition.name() + ' - ' + condition.description}"
                    th:selected="${card.cardCondition == condition}">
            </option>
          </select>
          <div class="help-text">MINT: 미개봉/신품, NEAR_MINT: S급 (거의 새것), EXCELLENT: A급 (약간의 사용감), LIGHTLY_PLAYED: B급 (눈에 띄는 상처), PLAYED: C급 (플레이용), HEAVILY_PLAYED: D급 (심한 사용 흔적), DAMAGED: 파손됨</div>
        </div>

        <div class="form-group">
          <label for="collectionStatus">컬렉션 상태 (Collection Status)</label>
          <select id="collectionStatus" name="collectionStatus">
            <option value="">선택하세요</option>
            <option th:each="status : ${collectionStatuses}" 
                    th:value="${status.name()}" 
                    th:text="${status.name() + ' - ' + status.description}"
                    th:selected="${card.collectionStatus == status}">
            </option>
          </select>
          <div class="help-text">OWNED: 보유중, WHISHLIST: 위시리스트(갖고싶음), FOR_TRADE: 교환중, FOR_SALE: 판매중, TRADED: 교환 완료, SOLD: 판매 완료</div>
        </div>

        <div class="form-group">
          <label for="quantity">수량 (Quantity)</label>
          <input
            type="text"
            id="quantity"
            name="quantity"
            th:value="${card.quantity != null ? card.quantity : 1}"
            placeholder="예: 1"
            inputmode="numeric"
            pattern="[0-9]*"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;"
          />
          <div class="help-text">
            * 보유 중인 카드의 수량을 입력하세요. 숫자만 입력 가능합니다. (기본값: 1)
          </div>
        </div>

        <div class="form-group">
          <label for="imageUrl">이미지 URL</label>
          <input type="text" id="imageUrl" name="imageUrl" th:value="${card.imageUrl}" />
          <div class="help-text">외부 이미지 URL을 입력하거나 아래에서 새 이미지를 업로드하세요.</div>
          <div th:if="${card.uploadedImageUrl != null}" style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 5px;">
            <p style="font-size: 0.85em; color: #666; margin-bottom: 5px;"><strong>업로드된 이미지 URL:</strong></p>
            <p style="font-size: 0.8em; color: #4338ca; word-break: break-all;" th:text="${card.uploadedImageUrl}"></p>
          </div>
          <div th:if="${card.getDisplayImageUrl() != null}" style="margin-top: 10px;">
            <p style="font-size: 0.9em; color: #666; margin-bottom: 5px;"><strong>현재 표시되는 이미지:</strong></p>
            <img th:src="${card.getDisplayImageUrl()}" alt="현재 이미지" class="current-image" 
                 onerror="this.onerror=null; this.src='/images/pokemon-card.png';" />
            <p style="font-size: 0.8em; color: #666; margin-top: 5px; word-break: break-all;" th:text="${card.getDisplayImageUrl()}"></p>
          </div>
        </div>

        <div class="form-group">
          <label for="imageFile">새 이미지 업로드</label>
          <input
            type="file"
            id="imageFile"
            name="imageFile"
            accept="image/*"
            style="padding: 8px;"
          />
          <div class="help-text">새 이미지를 업로드하면 기존 이미지를 대체합니다.</div>
          <div id="imagePreview" style="margin-top: 10px; display: none;">
            <img id="previewImg" src="" alt="미리보기" style="max-width: 300px; max-height: 300px; border: 1px solid #ddd; border-radius: 5px;" />
          </div>
        </div>

        <div class="form-group">
          <label for="quantity">수량 (Quantity)</label>
          <input
            type="text"
            id="quantity"
            name="quantity"
            th:value="${card.quantity != null ? card.quantity : 1}"
            placeholder="예: 1"
            inputmode="numeric"
            pattern="[0-9]*"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;"
          />
          <div class="help-text">
            * 보유 중인 카드의 수량을 입력하세요. 숫자만 입력 가능합니다. (기본값: 1)
          </div>
        </div>

        <div class="form-group">
          <label for="salePrice">판매 가격 (원화)</label>
          <div class="price-input-wrapper">
            <input
              type="text"
              id="salePrice"
              name="salePrice"
              th:value="${card.salePrice}"
              placeholder="예: 50000"
              inputmode="numeric"
              pattern="[0-9]*"
            />
          </div>
          <div class="help-text">판매하고자 하는 가격을 원화(₩)로 입력하세요.</div>
        </div>

        <div class="form-group">
          <label for="currentPriceUsd">현재 시세 (USD) - 선택사항</label>
          <div class="usd-input-wrapper">
            <input
              type="text"
              id="currentPriceUsd"
              name="currentPriceUsd"
              th:value="${currentMarketPrice != null && currentMarketPrice.price != null ? currentMarketPrice.price : ''}"
              placeholder="25.99"
              inputmode="decimal"
              pattern="[0-9]+(\.[0-9]+)?"
            />
          </div>
          <div class="help-text">
            * 카드의 현재 시세를 USD로 입력하세요. 소수점 포함 가능합니다. (예: 25.99)
            <br>* 입력된 시세는 그래프 데이터로 축적되어 가격 추이를 확인할 수 있습니다.
            <br>* 기존 시세를 변경하면 새로운 시세로 업데이트되고, PriceHistory에 기록이 추가됩니다.
          </div>
        </div>

        <button type="submit" class="btn-submit">수정 완료</button>
        <a href="/admin/cards/list" class="btn-cancel">취소</a>
      </form>
    </div>

    <script>
      // 이미지 미리보기 기능
      document.getElementById('imageFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const previewDiv = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            previewImg.src = e.target.result;
            previewDiv.style.display = 'block';
          };
          reader.readAsDataURL(file);
        } else {
          previewDiv.style.display = 'none';
        }
      });

      // 수량 입력란: 숫자만 입력 가능하도록 제한
      document.getElementById('quantity').addEventListener('input', function(e) {
        // 숫자가 아닌 문자 제거
        this.value = this.value.replace(/[^0-9]/g, '');
      });

      // 수량 입력란: 키보드 입력 제한
      document.getElementById('quantity').addEventListener('keydown', function(e) {
        // 숫자 키 (0-9), 백스페이스, 삭제, 탭, 화살표 키만 허용
        if (
          !(
            (e.key >= '0' && e.key <= '9') ||
            e.key === 'Backspace' ||
            e.key === 'Delete' ||
            e.key === 'Tab' ||
            e.key === 'ArrowLeft' ||
            e.key === 'ArrowRight' ||
            e.key === 'ArrowUp' ||
            e.key === 'ArrowDown'
          )
        ) {
          e.preventDefault();
        }
      });

      // 판매 가격 입력란: 숫자만 입력 가능하도록 제한
      document.getElementById('salePrice').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
      });

      // 현재 시세(USD) 입력란: 숫자와 소수점만 입력 가능하도록 제한
      const currentPriceUsdInput = document.getElementById('currentPriceUsd');
      if (currentPriceUsdInput) {
        currentPriceUsdInput.addEventListener('input', function(e) {
          // 숫자와 소수점만 허용 (소수점은 하나만)
          let value = this.value;
          // 숫자, 소수점, 백스페이스, 삭제 외의 문자 제거
          value = value.replace(/[^0-9.]/g, '');
          // 소수점이 여러 개인 경우 첫 번째만 유지
          const parts = value.split('.');
          if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
          }
          // 소수점 두 자리까지만 허용
          if (parts.length === 2 && parts[1].length > 2) {
            value = parts[0] + '.' + parts[1].substring(0, 2);
          }
          this.value = value;
        });

        // 현재 시세(USD) 입력란: 키보드 입력 제한
        currentPriceUsdInput.addEventListener('keydown', function(e) {
          // 숫자 키 (0-9), 소수점(.), 백스페이스, 삭제, 탭, 화살표 키만 허용
          if (
            !(
              (e.key >= '0' && e.key <= '9') ||
              e.key === '.' ||
              e.key === 'Backspace' ||
              e.key === 'Delete' ||
              e.key === 'Tab' ||
              e.key === 'ArrowLeft' ||
              e.key === 'ArrowRight' ||
              e.key === 'ArrowUp' ||
              e.key === 'ArrowDown'
            )
          ) {
            e.preventDefault();
          }
          // 소수점이 이미 있으면 또 입력하지 못하게
          if (e.key === '.' && this.value.includes('.')) {
            e.preventDefault();
          }
        });
      }
    </script>
  </body>
</html>

