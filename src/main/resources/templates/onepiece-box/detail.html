<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title th:text="${box.name} + ' - PokeKernel'">OnePiece Box Detail</title>
    <link rel="stylesheet" href="/css/card-list.css" />
    <style>
      body {
        margin: 0;
        padding: 20px;
        background: #f4f4f9;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .detail-container {
        display: flex;
        gap: 40px;
        max-width: 1200px;
        margin: 40px auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      /* 3D 박스 회전 영역 - Three.js 사용 */
      .scene-container {
        width: 400px;
        height: 450px;
        margin: 0 auto;
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        background-color: transparent;
        touch-action: none;
      }

      #three-canvas {
        display: block;
        width: 100%;
        height: 100%;
        cursor: grab;
      }

      #three-canvas:active {
        cursor: grabbing;
      }

      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-family: sans-serif;
        font-size: 1.2rem;
        pointer-events: none;
        z-index: 10;
      }

      .detail-info {
        flex: 1;
      }

      .detail-info h1 {
        margin-top: 0;
        color: #333;
      }

      .detail-info h2 {
        color: #d97706;
        margin-top: 20px;
      }

      .back-btn {
        display: inline-block;
        margin-bottom: 20px;
        text-decoration: none;
        color: white;
        font-weight: bold;
        padding: 10px 20px;
        background-color: #ef4444;
        border-radius: 5px;
      }

      .back-btn:hover {
        background-color: #dc2626;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.3s;
      }

      .btn-primary {
        background-color: #4338ca;
        color: white;
      }

      .btn-primary:hover {
        background-color: #3730a3;
      }

      /* 모바일 대응 - 태블릿 */
      @media (max-width: 1024px) {
        .detail-container {
          gap: 30px;
          padding: 25px;
        }
        
        .scene-container {
          width: 100%;
          max-width: 500px;
          height: 450px;
        }
      }
      
      /* 모바일 대응 - 스마트폰 */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }
        
        .detail-container {
          flex-direction: column;
          gap: 20px;
          margin: 20px auto;
          padding: 20px;
        }

        .scene-container {
          width: 100%;
          max-width: 100%;
          height: 350px;
        }
        
        .detail-info h1 {
          font-size: 1.3em;
        }
        
        .detail-info h2 {
          font-size: 1.1em;
        }
        
        .back-btn {
          width: 100%;
          text-align: center;
          min-height: 44px;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        
        .btn {
          min-height: 44px;
          padding: 12px 20px;
          font-size: 16px; /* iOS 자동 줌 방지 */
          width: 100%;
        }
      }
      
      /* 모바일 대응 - 작은 스마트폰 */
      @media (max-width: 480px) {
        body {
          padding: 8px;
        }
        
        .detail-container {
          padding: 15px;
          margin: 15px auto;
        }
        
        .scene-container {
          height: 300px;
        }
        
        .detail-info h1 {
          font-size: 1.1em;
        }
        
        .detail-info h2 {
          font-size: 1em;
        }
      }

      /* 정보 박스 스타일 */
      .info-box {
        margin-top: 15px;
        padding: 15px;
        background-color: #f9fafb;
        border-radius: 8px;
        border-left: 4px solid #4338ca;
      }

      .info-box div {
        margin-bottom: 8px;
      }

      .info-label {
        font-weight: bold;
        color: #4338ca;
        margin-bottom: 4px;
      }

      /* 수량 선택기 및 총 가격 */
      .quantity-section {
        margin-top: 20px;
        padding: 20px;
        background-color: #f9fafb;
        border-radius: 8px;
      }

      .quantity-controls {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
      }

      .quantity-selector {
        display: flex;
        align-items: center;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        overflow: hidden;
      }

      .quantity-btn {
        width: 40px;
        height: 40px;
        background-color: #f3f4f6;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #6b7280;
        transition: background-color 0.2s;
      }

      .quantity-btn:hover {
        background-color: #e5e7eb;
      }

      .quantity-input {
        width: 60px;
        height: 40px;
        text-align: center;
        border: none;
        border-left: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
        font-size: 16px;
        font-weight: 500;
        background-color: white;
        outline: none;
      }

      .total-price {
        flex: 1;
        min-width: 150px;
      }

      .total-price-label {
        font-size: 0.9em;
        color: #6b7280;
        margin-bottom: 4px;
      }

      .total-price-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #111827;
      }
    </style>
  </head>
  <body>
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 30px;">
      <a href="/shop/onepiece" class="back-btn">← Back to List</a>
    </div>

    <div class="detail-container">
      <!-- 3D 박스 회전 영역 - Three.js Canvas -->
      <div class="scene-container" id="scene-container">
        <div id="loading">이미지 로딩 중...</div>
        <canvas id="three-canvas"></canvas>
      </div>

      <!-- 상품 정보 -->
      <div class="detail-info">
        <h1 th:text="${box.name}">Box Name</h1>
        <p style="color: #666; font-size: 1.1em" th:text="${box.setName}">Set Name</p>

        <div class="info-box">
          <div th:if="${box.condition != null}">
            <div class="info-label">박스 상태 (Condition):</div>
            <div style="margin-left: 8px;">
              <span style="font-weight: 600;" th:text="${box.condition}">MINT</span>
              <span th:if="${box.conditionDesc != null}" style="color: #666; margin-left: 8px;" th:text="'(' + ${box.conditionDesc} + ')'">(미개봉/신품)</span>
            </div>
          </div>
          <div th:if="${box.collectionStatus != null}">
            <div class="info-label">컬렉션 상태 (Collection Status):</div>
            <div style="margin-left: 8px;">
              <span style="font-weight: 600;" th:text="${box.collectionStatus}">OWNED</span>
              <span th:if="${box.collectionStatusDesc != null}" style="color: #666; margin-left: 8px;" th:text="'(' + ${box.collectionStatusDesc} + ')'">(보유중)</span>
            </div>
          </div>
          <div th:if="${box.quantity != null and box.quantity > 0}">
            <div class="info-label">수량 (Quantity):</div>
            <div style="margin-left: 8px;">
              <span style="font-weight: 600; font-size: 1.1em; color: #4338ca;" th:text="${box.quantity} + '개'">1개</span>
            </div>
          </div>
        </div>

        <h2>
          <span th:text="${box.currency}">₩</span>
          <span th:text="${box.currentPrice}">-</span>
        </h2>

        <!-- 수량 선택기 및 총 가격 -->
        <div class="quantity-section">
          <div class="quantity-controls">
            <div class="quantity-selector">
              <button type="button" id="quantity-decrease" class="quantity-btn">−</button>
              <input type="text" id="quantity-input" class="quantity-input" value="1" min="1" />
              <button type="button" id="quantity-increase" class="quantity-btn">+</button>
            </div>
            <div class="total-price">
              <div class="total-price-label">총 가격</div>
              <div class="total-price-value">
                ₩<span id="total-price-value">0</span>
              </div>
            </div>
          </div>
        </div>

        <div th:if="${box.salePrice != null}" style="margin-top: 15px; padding: 15px; background-color: #f0f9ff; border-radius: 8px; border-left: 4px solid #4338ca;">
          <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">희망 판매 가격 (단가)</div>
          <div style="font-size: 1.3em; font-weight: bold; color: #4338ca;">
            ₩<span th:text="${#numbers.formatInteger(box.salePrice, 0, 'COMMA')}" id="unit-price">50,000</span>
          </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
          <a
            href="https://www.instagram.com/pokekenel?igsh=MTRuY3B6MGxwanJ0cw%3D%3D&utm_source=qr"
            class="btn btn-primary"
            target="_blank"
            rel="noopener noreferrer"
            style="flex: 1; min-width: 120px; text-align: center;"
          >
            + Instagram
          </a>
          <button
            type="button"
            id="add-to-cart-btn"
            class="btn"
            style="flex: 1; min-width: 120px; background-color: #10b981; color: white; border: none;"
          >
            + 장바구니
          </button>
          <button
            type="button"
            id="buy-now-btn"
            class="btn"
            style="flex: 1; min-width: 120px; background-color: #f59e0b; color: white; border: none;"
          >
            + 바로 구매
          </button>
        </div>
      </div>
    </div>

    <!-- Three.js Import Map -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>

    <script type="module" th:inline="javascript">
      import * as THREE from 'three';
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

      // Thymeleaf 변수를 JS 변수로 주입 (null 체크 강화)
      const boxImages = {
        front: /*[[${box.frontImageUrl != null && !box.frontImageUrl.isEmpty() ? box.frontImageUrl : ''}]]*/ '',
        back: /*[[${box.backImageUrl != null && !box.backImageUrl.isEmpty() ? box.backImageUrl : ''}]]*/ '',
        left: /*[[${box.leftImageUrl != null && !box.leftImageUrl.isEmpty() ? box.leftImageUrl : ''}]]*/ '',
        right: /*[[${box.rightImageUrl != null && !box.rightImageUrl.isEmpty() ? box.rightImageUrl : ''}]]*/ '',
        top: /*[[${box.topImageUrl != null && !box.topImageUrl.isEmpty() ? box.topImageUrl : ''}]]*/ '',
        bottom: /*[[${box.bottomImageUrl != null && !box.bottomImageUrl.isEmpty() ? box.bottomImageUrl : ''}]]*/ ''
      };

      // 디버깅: 이미지 URL 확인 (모바일에서도 확인 가능하도록 상세 로깅)
      console.log('Box Images (Raw):', boxImages);
      console.log('User Agent:', navigator.userAgent);
      console.log('Is Mobile:', /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));

      // 1. Scene Setup
      const scene = new THREE.Scene();
      scene.background = null;

      // 2. Camera Setup
      const container = document.getElementById('scene-container');
      const width = container.clientWidth;
      const height = container.clientHeight;
      const camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 1000);
      camera.position.set(3, 2, 4);

      // 3. Renderer Setup
      const canvas = document.getElementById('three-canvas');
      const renderer = new THREE.WebGLRenderer({ 
        canvas: canvas,
        antialias: true,
        alpha: true
      });
      renderer.setSize(width, height);
      renderer.setClearColor(0x000000, 0);
      renderer.setPixelRatio(window.devicePixelRatio);

      // 4. Controls (Drag to Rotate)
      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.rotateSpeed = 0.5;
      controls.enableZoom = true;
      controls.enablePan = false;

      // 5. Lighting
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);

      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(5, 5, 5);
      scene.add(dirLight);

      // 6. Texture Loading & Box Creation
      const loadingDiv = document.getElementById('loading');

      // 기본 텍스처 생성 함수
      function createDefaultTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 512;
        canvas.height = 512;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#333333';
        ctx.fillRect(0, 0, 512, 512);
        ctx.fillStyle = '#ffffff';
        ctx.font = '48px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('이미지 없음', 256, 256);
        const texture = new THREE.CanvasTexture(canvas);
        texture.colorSpace = THREE.SRGBColorSpace;
        return texture;
      }

      // 이미지 URL 배열 (Three.js BoxGeometry Material Index 순서)
      // 0: Right (+x), 1: Left (-x), 2: Top (+y), 3: Bottom (-y), 4: Front (+z), 5: Back (-z)
      const textureUrls = [
        boxImages.right || '',
        boxImages.left || '',
        boxImages.top || '',
        boxImages.bottom || '',
        boxImages.front || '',
        boxImages.back || ''
      ];

      // 상대 경로를 절대 경로로 변환하는 함수 (모바일 대응 강화)
      function toAbsoluteUrl(url) {
        if (!url || url.trim() === '') {
          console.log('toAbsoluteUrl: 빈 URL');
          return '';
        }
        
        // 이미 절대 URL이면 그대로 반환
        if (url.startsWith('http://') || url.startsWith('https://')) {
          console.log('toAbsoluteUrl: 절대 URL 유지:', url);
          return url;
        }
        
        // 상대 경로인 경우 현재 도메인 추가
        const origin = window.location.origin;
        let absoluteUrl;
        
        if (url.startsWith('/')) {
          absoluteUrl = origin + url;
        } else {
          // 상대 경로 (예: uploads/images/xxx.jpg)
          absoluteUrl = origin + '/' + url;
        }
        
        console.log('toAbsoluteUrl: 변환 완료:', url, '->', absoluteUrl);
        return absoluteUrl;
      }

      // textures 변수 선언
      let textures = [];

      // 텍스처 로드 함수 (모바일 대응 강화, 재시도 로직 포함)
      function loadTexture(url, index, retryCount = 0) {
        return new Promise((resolve, reject) => {
          // 원본 URL이 비어있으면 기본 텍스처 사용
          if (!url || url.trim() === '') {
            console.log(`텍스처 ${index}: 원본 URL이 비어있음, 기본 텍스처 사용`);
            const defaultTexture = createDefaultTexture();
            resolve(defaultTexture);
            return;
          }
          
          const absoluteUrl = toAbsoluteUrl(url);
          console.log(`텍스처 ${index} 로드 시작 (시도 ${retryCount + 1}/2):`, absoluteUrl);
          
          if (!absoluteUrl || absoluteUrl.trim() === '') {
            // 절대 URL 변환 실패 시 기본 텍스처 사용
            console.log(`텍스처 ${index}: 절대 URL 변환 실패, 기본 텍스처 사용`);
            const defaultTexture = createDefaultTexture();
            resolve(defaultTexture);
            return;
          }
          
          // 이미지 URL 유효성 사전 검사 (모바일에서도 작동)
          const img = new Image();
          img.crossOrigin = 'anonymous';
          
          // 이미지 로드 성공 시 Three.js 텍스처로 변환
          img.onload = function() {
            console.log(`텍스처 ${index}: 이미지 사전 로드 성공, Three.js 텍스처 생성:`, absoluteUrl);
            const textureLoader = new THREE.TextureLoader();
            textureLoader.crossOrigin = 'anonymous';
            textureLoader.load(
              absoluteUrl,
              (texture) => {
                texture.colorSpace = THREE.SRGBColorSpace;
                console.log(`텍스처 ${index} 로드 성공:`, absoluteUrl);
                resolve(texture);
              },
              undefined,
              (err) => {
                console.error(`텍스처 ${index}: Three.js 텍스처 로드 오류:`, absoluteUrl, err);
                // 재시도 (최대 1회)
                if (retryCount < 1) {
                  console.log(`텍스처 ${index}: 재시도 중...`);
                  setTimeout(() => {
                    loadTexture(url, index, retryCount + 1).then(resolve).catch(() => {
                      const defaultTexture = createDefaultTexture();
                      resolve(defaultTexture);
                    });
                  }, 1000);
                } else {
                  const defaultTexture = createDefaultTexture();
                  resolve(defaultTexture);
                }
              }
            );
          };
          
          // 이미지 로드 실패 시
          img.onerror = function(err) {
            console.error(`텍스처 ${index}: 이미지 사전 로드 실패:`, absoluteUrl, err);
            // 재시도 (최대 1회)
            if (retryCount < 1) {
              console.log(`텍스처 ${index}: 재시도 중...`);
              setTimeout(() => {
                loadTexture(url, index, retryCount + 1).then(resolve).catch(() => {
                  const defaultTexture = createDefaultTexture();
                  resolve(defaultTexture);
                });
              }, 1000);
            } else {
              // 재시도 실패 시 기본 텍스처 사용
              console.log(`텍스처 ${index}: 재시도 실패, 기본 텍스처 사용`);
              const defaultTexture = createDefaultTexture();
              resolve(defaultTexture);
            }
          };
          
          // 이미지 로드 시작
          img.src = absoluteUrl;
        });
      }

      // 모든 텍스처 로드
      Promise.all(textureUrls.map((url, index) => loadTexture(url, index)))
        .then((loadedTextures) => {
          textures = loadedTextures;
          console.log('모든 텍스처 로드 완료:', textures);
          loadingDiv.style.display = 'none';
          createBox();
        })
        .catch((err) => {
          console.error('텍스처 로드 중 오류 발생:', err);
          // 에러 발생 시 기본 텍스처로 채우기
          textures = textureUrls.map(() => createDefaultTexture());
          loadingDiv.style.display = 'none';
          createBox();
        });

      function createBox() {
        const boxWidth = 0.9;
        const boxHeight = 1.7;
        const boxDepth = 1.1;

        const geometry = new THREE.BoxGeometry(boxWidth, boxHeight, boxDepth);

        while (textures.length < 6) {
          textures.push(createDefaultTexture());
        }

        const materials = textures.map(texture => 
          new THREE.MeshStandardMaterial({ map: texture })
        );

        const box = new THREE.Mesh(geometry, materials);
        box.scale.set(2.0, 2.0, 2.0); // 모든 방향으로 1.5배 확대
        scene.add(box);
      }

      // 7. Animation Loop
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      // 8. Responsive Design
      window.addEventListener('resize', () => {
        const newWidth = container.clientWidth;
        const newHeight = container.clientHeight;
        camera.aspect = newWidth / newHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(newWidth, newHeight);
      });
    </script>

    <script th:inline="javascript">
      // 수량 선택기 기능
      const quantityInput = document.getElementById('quantity-input');
      const decreaseBtn = document.getElementById('quantity-decrease');
      const increaseBtn = document.getElementById('quantity-increase');
      const totalPriceValue = document.getElementById('total-price-value');
      const unitPriceElement = document.getElementById('unit-price');

      const maxQuantity = /*[[${box.quantity != null && box.quantity > 0 ? box.quantity : 999999}]]*/ 999999;
      const unitPrice = /*[[${box.salePrice != null ? box.salePrice : 0}]]*/ 0;

      function updateIncreaseButton() {
        const currentValue = parseInt(quantityInput.value) || 1;
        if (currentValue >= maxQuantity) {
          increaseBtn.disabled = true;
          increaseBtn.style.opacity = '0.5';
          increaseBtn.style.cursor = 'not-allowed';
        } else {
          increaseBtn.disabled = false;
          increaseBtn.style.opacity = '1';
          increaseBtn.style.cursor = 'pointer';
        }
      }

      function updateTotalPrice() {
        const quantity = parseInt(quantityInput.value) || 1;
        const total = unitPrice * quantity;
        totalPriceValue.textContent = total.toLocaleString('ko-KR');
        updateIncreaseButton();
      }

      decreaseBtn.addEventListener('click', function() {
        let currentValue = parseInt(quantityInput.value) || 1;
        if (currentValue > 1) {
          quantityInput.value = currentValue - 1;
          updateTotalPrice();
        }
      });

      increaseBtn.addEventListener('click', function() {
        let currentValue = parseInt(quantityInput.value) || 1;
        if (currentValue < maxQuantity) {
          quantityInput.value = currentValue + 1;
          updateTotalPrice();
        } else {
          alert('수량은 보유 중인 박스 수량(' + maxQuantity + '개)을 초과할 수 없습니다.');
        }
      });

      quantityInput.addEventListener('input', function(e) {
        let value = this.value.replace(/[^0-9]/g, '');
        if (value === '' || parseInt(value) < 1) {
          value = '1';
        }
        if (parseInt(value) > maxQuantity) {
          value = maxQuantity.toString();
          alert('수량은 보유 중인 박스 수량(' + maxQuantity + '개)을 초과할 수 없습니다.');
        }
        this.value = value;
        updateTotalPrice();
      });

      quantityInput.addEventListener('blur', function(e) {
        let value = parseInt(this.value) || 1;
        if (value < 1) {
          this.value = '1';
        } else if (value > maxQuantity) {
          this.value = maxQuantity.toString();
          alert('수량은 보유 중인 박스 수량(' + maxQuantity + '개)을 초과할 수 없습니다.');
        }
        updateTotalPrice();
      });

      updateTotalPrice();
    </script>
  </body>
</html>
